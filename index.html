<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:fb="http://ogp.me/ns/fb#">
    <head>
        <title>ConfConnect - Selfie Capture</title>
        <meta charset="utf-8">
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.92.0.min.js"></script>
        <style>
            video { border: 1px solid #ccc; display: block; margin: 0 0 20px 0; }
            #canvas { margin-top: 20px; border: 1px solid #ccc; display: block; }
        </style>

    </head>
    <body>

        <div id="LoginButtons">
            <div class="fb-login-button" data-max-rows="1" data-size="medium" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="true" data-use-continue-as="true"></div>
        </div>
        <img id="image" width="640" height="480" style="display:none"></img>
        <video id="video" width="640" height="480" autoplay style="display:none"></video>
        <button id="snap-button" class="sexyButton" style="display:none">Snap Photo</button>
        <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
        <button id="save-button" style="display:none">Use this image</button>
        <button id="tryAgain-button" style="display:none">Try again</button>
        <div id="results"></div>

        <script type="text/javascript">
            var appId = '682146731983534';
            var roleArn = 'arn:aws:iam::017491810838:role/FaceBook_user_role';
            var bucketName = 'confconnect.dev.userphotos';
            var imageBasePath = 'https://s3-us-west-2.amazonaws.com/confconnect.dev.userphotos/';
            AWS.config.region = 'us-west-2';
    
            var fbUserId;
            var bucket = new AWS.S3({
                params: {
                    Bucket: bucketName
                }
            });
    
            var saveButton = document.getElementById('save-button');
            var results = document.getElementById('results');
    
            saveButton.addEventListener('click', function () {
                var blobData = canvasToBlob('canvas');
                var fileName = 'facebook-' + fbUserId + '/MySelfie.png';
                var params = {
                    Key: fileName, 
                    ContentType: blobData.type, 
                    Body: blobData,
                    ACL: 'public-read'
                };
                bucket.upload(params, function (err, data) {
                    console.log(data);
                    if(err)
                    {
                        console.log('ERROR!');
                    }else{
                        console.log('Selfie uploaded!');
                        image.src = imageBasePath + 'facebook-' + fbUserId + '/MySelfie.png';
                    }
                });
            }, false);
            function canvasToBlob(elementId) {
                var contentType = 'image/jpeg';
                var canvas = document.getElementById('canvas');
                var dataUrl = canvas.toDataURL(contentType);
                var bytes = dataURItoBytes(dataUrl);                
                return new Blob([bytes], {type: contentType});
            }
            function dataURItoBytes(dataURI) {
                var binary = atob(dataURI.split(',')[1]);
                var array = [];
                for(var i = 0; i < binary.length; i++) {
                    array.push(binary.charCodeAt(i));
                }
                return new Uint8Array(array);
            }
            
            /*!
             * Login to your application using Facebook.
             * Uses the Facebook SDK for JavaScript available here:
             * https://developers.facebook.com/docs/javascript/quickstart/
             */
            window.fbAsyncInit = function () {
                FB.init({
                    appId: appId,
                    cookie     : true,  // enable cookies to allow the server to access 
                                        // the session
                    xfbml      : true,  // parse social plugins on this page i.e. fb-login-button
                    version    : 'v2.8' // use graph api version 2.8
                });
                FB.getLoginStatus(function(response) {
                    if (response.status === 'connected') {
                        console.log('Logged in.');
                        console.log(response);
                    }
                });
                FB.login(function (response) {
                    console.log('login response');
                    console.log(response);
                    bucket.config.credentials = new AWS.WebIdentityCredentials({
                        ProviderId: 'graph.facebook.com',
                        RoleArn: roleArn,
                        WebIdentityToken: response.authResponse.accessToken
                    });
                    fbUserId = response.authResponse.userID;
                    image.src = imageBasePath + 'facebook-' + fbUserId + '/MySelfie.png';
                })
            };

            //If we want to chase being able to turn off the camera, then maybe make this an object with capture() and stop() methods.
            //  else, we can just navigate away once the selfie is captured. -->POST
            function captureCameraTo(video) {
                var mediaConfig =  { video: true };
                var errBack = function(e) {
                    console.log('An error has occurred!', e)
                };
                // Put video listeners into place
                if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia(mediaConfig).then(function(stream) {
                        video.src = window.URL.createObjectURL(stream);
                        video.play();                        
                    });
                }

                /* Legacy code below! */
                else if(navigator.getUserMedia) { // Standard
                    navigator.getUserMedia(mediaConfig, function(stream) {
                        video.src = stream;
                        video.play();
                    }, errBack);
                } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
                    navigator.webkitGetUserMedia(mediaConfig, function(stream){
                        video.src = window.webkitURL.createObjectURL(stream);
                        video.play();
                    }, errBack);
                } else if(navigator.mozGetUserMedia) { // Mozilla-prefixed
                    navigator.mozGetUserMedia(mediaConfig, function(stream){
                        video.src = window.URL.createObjectURL(stream);
                        video.play();

                    }, errBack);
                }
            }

            // Put event listeners into place
            window.addEventListener("DOMContentLoaded", function() {
                // Grab elements, create settings, etc.
                var image = document.getElementById('image');
                var canvas = document.getElementById('canvas');
                var context = canvas.getContext('2d');
                var video = document.getElementById('video');
                var snapButton = document.getElementById('snap-button');
                var tryAgainButton = document.getElementById('tryAgain-button');
                
                //Try to load webcam feed.
                captureCameraTo(video);

                // Trigger photo take
                snapButton.addEventListener('click', function() {
                    context.drawImage(video, 0, 0, 640, 480);
                    video.style.display = 'none';
                    snapButton.style.display = 'none';
                    canvas.style.display = 'block';
                    saveButton.style.display = 'block';
                    tryAgainButton.style.display = 'block';
                });
                tryAgainButton.addEventListener('click', function() {
                    canvas.style.display = 'none';
                    image.style.display = 'none';
                    saveButton.style.display = 'none';
                    tryAgainButton.style.display = 'none';
                    video.style.display = 'block';
                    snapButton.style.display = 'block';
                });

                image.onload=function(){
                    console.log('Selfie image loaded.');
                    //hide the video and canvas
                    video.style.display = 'none';
                    canvas.style.display = 'none';
                    snapButton.style.display = 'none';
                    //Show the image
                    image.style.display = 'block';
                    tryAgainButton.style.display = 'block';
                };
                image.onerror=function(){
                    console.log('Selfie image failed to load.');
                    //hide the image and canvas
                    image.style.display = 'none';
                    canvas.style.display = 'none';
                    tryAgainButton.style.display = 'none';
                    //Show the video
                    video.style.display = 'block';
                    snapButton.style.display = 'block';
                };
                
            }, false);

             // Load the Facebook SDK asynchronously
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "https://connect.facebook.net/en_US/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
    </body>
</html>